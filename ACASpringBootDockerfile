FROM alpine:latest as maven-builder
ARG PROJECT_NAME
ARG TAG_NAME
ENV PROJECT_NAME=${PROJECT_NAME}
ENV TAG_NAME=${TAG_NAME}

RUN apk update
RUN if echo $TAG_NAME | grep -q "11" ; then \
         apk add --no-cache openjdk11 && apk add --no-cache maven; \
    elif echo $TAG_NAME | grep -q "17" ; then \
         apk add --no-cache openjdk17 && apk add --no-cache maven; \
    elif echo $TAG_NAME | grep -q "21" ; then \
         apk add --no-cache openjdk21 && apk add --no-cache maven; \
    else \
         apk add --no-cache openjdk8 && apk add --no-cache maven; \
    fi

COPY . /app
WORKDIR /app
RUN mvn clean install -pl ACA-Java-Agent-Log-Level/${PROJECT_NAME} -DskipTests

FROM maven:3-eclipse-temurin-21-alpine
ARG PROJECT_NAME
ENV PROJECT_NAME=${PROJECT_NAME}
COPY --from=maven-builder app/ACA-Java-Agent-Log-Level/${PROJECT_NAME}/target/*.jar /app-service/app.jar
WORKDIR /app-service
RUN wget https://acaagentaccount.blob.core.windows.net/agent/ja-agent-0.0.1-SNAPSHOT.jar -O agent-0.0.1-SNAPSHOT.jar
ADD /logleveljson/spring-boot-log-level.json /app-service/log-level.json
EXPOSE 8080
ENTRYPOINT ["java","-javaagent:agent-0.0.1-SNAPSHOT.jar", "-DK8SE_JAVA_AGENT_CONFIG_FILE=log-level.json","-jar", "app.jar"]
