FROM alpine:latest as maven-builder
ARG PROJECT_NAME
ENV PROJECT_NAME=${PROJECT_NAME}

RUN apk update
RUN if $PROJECT_NAME | grep -q "quarkus-logback-11" ; then \
         apk add --no-cache openjdk11 && apk add --no-cache maven=3.8.1-r0; \
    elif $PROJECT_NAME | grep -q "quarkus-logback-17" ; then \
         apk add --no-cache openjdk17 && apk add --no-cache maven=3.8.1-r0; \
    elif $PROJECT_NAME | grep -q "quarkus-logback-21" ; then \
         apk add --no-cache openjdk21 && apk add --no-cache maven=3.8.1-r0; \
    fi

COPY . /app
WORKDIR /app
RUN mvn clean install -pl ACA-Java-Agent-Log-Level/${PROJECT_NAME} -DskipTests

FROM maven:3-eclipse-temurin-11-alpine
WORKDIR /app
ARG PROJECT_NAME
ENV PROJECT_NAME=${PROJECT_NAME}
# copy arthas
COPY --from=hengyunabc/arthas:latest /opt/arthas /opt/arthas
COPY --from=maven-builder app/ACA-Java-Agent-Log-Level/${PROJECT_NAME}/target/*.jar /app-service/target/quarkus-logback-1.0.0-runner.jar

RUN apk add wget unzip tcpdump ngrep iproute2-ss bind-tools

COPY ./ ./

RUN wget https://huiagentaccount.blob.core.windows.net/ja-agent/agent-0.0.1-SNAPSHOT.jar

RUN if $PROJECT_NAME | grep -q "aca-otlp" ; then \
         wget https://huiagentaccount.blob.core.windows.net/opentelemetry-javaagent/opentelemetry-javaagent.jar; \
    elif $PROJECT_NAME | grep -q "aca-ai" ; then \
         wget https://huiagentaccount.blob.core.windows.net/applicationinsights-agent/applicationinsights-agent-3.4.19.jar; \
    fi

ENTRYPOINT ["sh", "-c"]

CMD if $PROJECT_NAME | grep -q "aca-otlp" ; then \
         ["java -javaagent:agent-0.0.1-SNAPSHOT.jar -javaagent:opentelemetry-javaagent.jar -Xms256m -Xmx256m -jar /app-service/target/quarkus-logback-1.0.0-runner.jar"]; \
    elif $PROJECT_NAME | grep -q "aca-ai" ; then \
         ["java -javaagent:agent-0.0.1-SNAPSHOT.jar -javaagent:applicationinsights-agent-3.4.19.jar -Xms256m -Xmx256m -jar /app-service/target/quarkus-logback-1.0.0-runner.jar"]; \
    else \
         ["java -javaagent:agent-0.0.1-SNAPSHOT.jar -Xms256m -Xmx256m -jar /app-service/target/quarkus-logback-1.0.0-runner.jar"]; \
    fi
